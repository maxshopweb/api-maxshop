generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELOS ORIGINALES (SIN MODIFICAR)
// ============================================

model negocio {
  id_neg           Int     @id @default(autoincrement())
  nombre           String? @db.VarChar(255)
  direccion        String? @db.VarChar(255)
  logo             String? @db.VarChar(255)
  telefono         String? @db.VarChar(50)
  cuit             String? @db.VarChar(50)
  cond_iva         String? @db.VarChar(100)
  email            String? @db.VarChar(255)
  color_primario   String? @db.VarChar(20)
  color_secundario String? @db.VarChar(20)
  token_pago       String? @db.VarChar(255)
  token_envio      String? @db.VarChar(255)
}

model roles {
  id_rol      Int        @id @default(autoincrement())
  nombre      String?    @db.VarChar(100)
  descripcion String?    @db.VarChar(255)
  usuarios    usuarios[]
}


model admin {
  id_admin   String?  @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  id_usuario String   @id @db.VarChar(150)
  usuarios   usuarios @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
}

model cliente {
  id_cliente    String?  @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  id_usuario    String   @id @db.VarChar(150)
  direccion     String?  @db.VarChar(255)
  cod_postal    Int?
  ciudad        String?  @db.VarChar(100)
  provincia     String?  @db.VarChar(100)
  usuarios      usuarios @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade, onUpdate: NoAction)
  venta_cliente venta[]  @relation("venta_cliente")
}

model eventos {
  id_evento      Int             @id @default(autoincrement())
  nombre         String?         @db.VarChar(255)
  descripcion    String?
  fecha_inicio   DateTime?       @db.Timestamp(6)
  fecha_fin      DateTime?       @db.Timestamp(6)
  tipo_descuento String?         @db.VarChar(50)
  banner_img     String?         @db.VarChar(255)
  color_tema     String?         @db.VarChar(20)
  activo         Boolean?        @default(true)
  creado_en      DateTime?       @default(now()) @db.Timestamp(6)
  url_publica    String?         @db.VarChar(255)
  reglas_evento  reglas_evento[]
  venta_detalle  venta_detalle[]
}

model auditoria {
  id_aud               Int       @id @default(autoincrement())
  id_usuario           String?   @db.VarChar(150)
  fecha                DateTime? @default(now()) @db.Timestamp(6)
  accion               String?   @db.VarChar(100)
  tabla_afectada       String?   @db.VarChar(100)
  dato_anterior        Json?
  dato_despues         Json?
  user_agent           String?   @db.VarChar(255)
  endpoint             String?   @db.VarChar(255)
  estado               String?   @db.VarChar(50)
  descripcion          String?   @db.VarChar(255)
  tiempo_procesamiento Int?
  usuarios             usuarios? @relation(fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction)

  @@index([fecha], map: "idx_auditoria_fecha")
  @@index([id_usuario], map: "idx_auditoria_usuario")
}

model venta {
  id_venta        Int             @id @default(autoincrement())
  id_usuario      String?         @db.VarChar(150)
  fecha           DateTime?       @default(now()) @db.Timestamp(6)
  id_cliente      String?         @db.VarChar(150)
  total_sin_iva   Decimal?        @db.Decimal(10, 2)
  total_con_iva   Decimal?        @db.Decimal(10, 2)
  descuento_total Decimal?        @db.Decimal(10, 2)
  total_neto      Decimal?        @db.Decimal(10, 2)
  metodo_pago     String?         @db.VarChar(50)
  estado_pago     String?         @db.VarChar(50)
  estado_envio    String?         @db.VarChar(50)
  id_envio        String?         @db.Uuid
  tipo_venta      String?         @db.VarChar(50)
  observaciones   String?
  factura_url     String?         @db.VarChar(255)
  creado_en       DateTime?       @default(now()) @db.Timestamp(6)
  actualizado_en  DateTime?       @default(now()) @db.Timestamp(6)
  envios          envios[]
  cliente         cliente?        @relation("venta_cliente", fields: [id_cliente], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction)
  usuario         usuarios?       @relation("venta_usuario", fields: [id_usuario], references: [id_usuario], onDelete: NoAction, onUpdate: NoAction)
  venta_detalle   venta_detalle[]

  @@index([id_cliente], map: "idx_venta_cliente")
  @@index([fecha], map: "idx_venta_fecha")
}

model envios {
  id_envio        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  id_venta        Int?
  empresa_envio   String?   @db.VarChar(100)
  cod_seguimiento String?   @db.VarChar(100)
  estado_envio    String?   @db.VarChar(50)
  costo_envio     Decimal?  @db.Decimal(10, 2)
  direccion_envio String?   @db.VarChar(255)
  fecha_envio     DateTime? @db.Timestamp(6)
  fecha_entrega   DateTime? @db.Timestamp(6)
  observaciones   String?
  venta           venta?    @relation(fields: [id_venta], references: [id_venta], onDelete: NoAction, onUpdate: NoAction)
}

model reglas_contenido {
  id_contenido  Int?
  id_regla      Int           @id(map: "Reglas-Contenido_pkey") @default(autoincrement())
  tipo_objetivo String?       @db.VarChar(50)
  id_objetivo   Int?
  reglas_evento reglas_evento @relation(fields: [id_regla], references: [id_regla], onDelete: NoAction, onUpdate: NoAction, map: "Reglas-Contenido_id_regla_fkey")

  @@map("reglas-contenido")
}

model reglas_evento {
  id_regla         Int               @id(map: "Reglas-Evento_pkey") @default(autoincrement())
  id_evento        Int?
  tipo_desc        String?           @db.VarChar(50)
  valor_desc       Decimal?          @db.Decimal(10, 2)
  desc_regla       String?           @db.VarChar(255)
  condicion_extra  Json?
  activo           Boolean?          @default(true)
  creado_en        DateTime?         @default(now()) @db.Timestamp(6)
  reglas_contenido reglas_contenido?
  eventos          eventos?          @relation(fields: [id_evento], references: [id_evento], onDelete: NoAction, onUpdate: NoAction, map: "Reglas-Evento_id_evento_fkey")

  @@map("reglas-evento")
}

model venta_detalle {
  id_detalle         Int        @id(map: "Venta-detalle_pkey") @default(autoincrement())
  id_venta           Int?
  id_prod            Int?
  cantidad           Int?
  precio_unitario    Decimal?   @db.Decimal(10, 2)
  descuento_aplicado Decimal?   @db.Decimal(10, 2)
  sub_total          Decimal?   @db.Decimal(10, 2)
  evento_aplicado    Int?
  tipo_descuento     String?    @db.VarChar(50)
  eventos            eventos?   @relation(fields: [evento_aplicado], references: [id_evento], onDelete: NoAction, onUpdate: NoAction, map: "Venta-detalle_evento_aplicado_fkey")
  productos          productos? @relation(fields: [id_prod], references: [id_prod], onDelete: NoAction, onUpdate: NoAction, map: "Venta-detalle_id_prod_fkey")
  venta              venta?     @relation(fields: [id_venta], references: [id_venta], onDelete: NoAction, onUpdate: NoAction, map: "Venta-detalle_id_venta_fkey")

  @@map("venta-detalle")
}

// ============================================
// MODELOS DE REFERENCIA DESDE CSV
// ============================================

model categoria {
  id_cat         Int         @id @default(autoincrement())
  codi_categoria String      @unique @db.VarChar(4) // CODICATE del CSV
  nombre         String?     @db.VarChar(100) // DESCCATE del CSV
  descripcion    String?     @db.VarChar(255)
  activo         Boolean?    @default(true)
  creado_en      DateTime?   @default(now()) @db.Timestamp(6)
  actualizado_en DateTime?   @default(now()) @db.Timestamp(6)
  productos      productos[]

  @@index([codi_categoria], map: "idx_categoria_codigo")
}

model iva {
  id_iva         Int         @id @default(autoincrement())
  codi_impuesto  String      @unique @db.VarChar(2) // CODIIMPU del CSV
  nombre         String?     @db.VarChar(100) // DESCIMPU del CSV
  porcentaje     Decimal?    @db.Decimal(8, 4) // PORCIMPU del CSV
  descripcion    String?     @db.VarChar(255)
  activo         Boolean?    @default(true)
  creado_en      DateTime?   @default(now()) @db.Timestamp(6)
  actualizado_en DateTime?   @default(now()) @db.Timestamp(6)
  productos      productos[]

  @@index([codi_impuesto], map: "idx_iva_codigo")
}

model marca {
  id_marca       Int         @id @default(autoincrement())
  codi_marca     String      @unique @db.VarChar(3) // CODIMARC del CSV
  nombre         String?     @db.VarChar(100) // DESCMARC del CSV
  descripcion    String?     @db.VarChar(255)
  activo         Boolean?    @default(true)
  creado_en      DateTime?   @default(now()) @db.Timestamp(6)
  actualizado_en DateTime?   @default(now()) @db.Timestamp(6)
  productos      productos[]

  @@index([codi_marca], map: "idx_marca_codigo")
}

model grupo {
  id_grupo       Int         @id @default(autoincrement())
  codi_grupo     String      @unique @db.VarChar(4) // CODIGRAR del CSV
  nombre         String?     @db.VarChar(100) // DESCGRAR del CSV
  descripcion    String?     @db.VarChar(255)
  activo         Boolean?    @default(true)
  creado_en      DateTime?   @default(now()) @db.Timestamp(6)
  actualizado_en DateTime?   @default(now()) @db.Timestamp(6)
  productos      productos[]

  @@index([codi_grupo], map: "idx_grupo_codigo")
}

// ============================================
// MODELO PRODUCTOS MODIFICADO
// ============================================

model productos {
  id_prod Int @id @default(autoincrement())

  // Campos principales del CSV
  codi_arti   String  @unique @db.VarChar(10) // CODIARTI
  nombre      String? @db.VarChar(255) // DESCARTI
  descripcion String?

  // Relaciones (usando códigos del CSV directamente)
  codi_categoria String? @db.VarChar(4) // CODICATE - Relación con categoria
  codi_marca     String? @db.VarChar(3) // CODIMARC - Relación con marca
  codi_grupo     String? @db.VarChar(4) // CODIGRAR - Relación con grupo
  codi_impuesto  String? @db.VarChar(2) // CODIIMPU - Relación con iva

  categoria categoria? @relation(fields: [codi_categoria], references: [codi_categoria], onDelete: SetNull, onUpdate: Cascade)
  marca     marca?     @relation(fields: [codi_marca], references: [codi_marca], onDelete: SetNull, onUpdate: Cascade)
  grupo     grupo?     @relation(fields: [codi_grupo], references: [codi_grupo], onDelete: SetNull, onUpdate: Cascade)
  iva       iva?       @relation(fields: [codi_impuesto], references: [codi_impuesto], onDelete: SetNull, onUpdate: Cascade)

  // Precios
  precio         Decimal? @db.Decimal(19, 6) // precio_venta del CSV
  precio_sin_iva Decimal? @db.Decimal(19, 6)
  iva_monto      Decimal? @db.Decimal(19, 6)

  // Unidades y medidas
  unidad_medida         String?  @db.VarChar(3) // UNMEARTI
  unidades_por_producto Decimal? @db.Decimal(5, 0) // UNENARTI

  // Código de barras
  codi_barras String? @db.VarChar(22) // PARTARTI

  // Stock
  stock Decimal? @db.Decimal(12, 2) // Stock actual desde MAESSTOK

  // Imagen
  img_principal String? @db.VarChar(120) // IMAGARTI

  // Estado
  activo String? @db.VarChar(1) // ACTIARTI (A/N)
  estado Int?    @default(1)

  // Campos adicionales del schema original (mantenidos)
  id_interno       String?   @db.VarChar(100)
  cod_sku          String?   @db.VarChar(100)
  modelo           String?   @db.VarChar(100)
  precio_mayorista Decimal?  @db.Decimal(10, 2)
  precio_minorista Decimal?  @db.Decimal(10, 2)
  precio_evento    Decimal?  @db.Decimal(10, 2)
  stock_min        Int?
  stock_mayorista  Int?
  imagenes         Json?
  destacado        Boolean?  @default(false)
  financiacion     Boolean?  @default(false)
  creado_en        DateTime? @default(now()) @db.Timestamp(6)
  actualizado_en   DateTime? @default(now()) @db.Timestamp(6)

  venta_detalle venta_detalle[]

  @@index([codi_arti], map: "idx_productos_codi_arti")
  @@index([codi_barras], map: "idx_productos_codi_barras")
  @@index([codi_categoria], map: "idx_productos_categoria")
  @@index([codi_marca], map: "idx_productos_marca")
  @@index([codi_grupo], map: "idx_productos_grupo")
  @@index([codi_impuesto], map: "idx_productos_iva")
  @@index([nombre], map: "idx_productos_nombre")
  @@index([activo], map: "idx_productos_activo")
}
